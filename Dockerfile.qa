# Dockerfile simplificado para Cloud Run
FROM node:22-slim

# Build argument para DATABASE_URL
ARG DATABASE_URL

# Usar apenas dependÃªncias jÃ¡ incluÃ­das na imagem Node

# Definir diretÃ³rio de trabalho
WORKDIR /app

# Instalar pnpm
RUN npm install -g pnpm

# Copiar arquivos de configuraÃ§Ã£o
COPY package.json pnpm-lock.yaml ./

# Instalar dependÃªncias (incluindo devDependencies para o build)
# Usar --shamefully-hoist para garantir layout compatÃ­vel com Node.js padrÃ£o
# Isso coloca todas as dependÃªncias em node_modules/ diretamente, sem symlinks complexos
RUN pnpm config set shamefully-hoist true && \
    pnpm install --frozen-lockfile

# Copiar cÃ³digo fonte
# O .dockerignore jÃ¡ exclui node_modules/, entÃ£o os node_modules instalados acima sÃ£o preservados
COPY . .

# Gerar Prisma Client com DATABASE_URL disponÃ­vel
ENV DATABASE_URL=$DATABASE_URL
RUN npx prisma generate

# Debug - verificar arquivos e configs
RUN echo "ğŸ” Verificando arquivos src..." && \
    ls -la src/ && \
    echo "ğŸ“„ Verificando entry point..." && \
    ls -la src/main.ts && \
    echo "ğŸ“‹ ConfiguraÃ§Ãµes:" && \
    cat nest-cli.json && \
    echo "---" && \
    cat tsconfig.build.json && \
    echo "---" && \
    echo "ğŸ” O que TypeScript estÃ¡ compilando..." && \
    npx tsc --listFiles --noEmit && \
    echo "ğŸš€ Tentando build normal..." && \
    pnpm run build

# Definir variÃ¡veis de ambiente padrÃ£o
ENV NODE_ENV=production
ENV PORT=8080

# Expor porta 8080
EXPOSE 8080

# Iniciar aplicaÃ§Ã£o diretamente
CMD ["node", "dist/main.js"]
