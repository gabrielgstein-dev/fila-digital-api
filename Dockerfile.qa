# Dockerfile otimizado para Cloud Run com multi-stage build
# ================================================

# Stage 1: Builder - Instala depend√™ncias e faz o build
FROM node:24-slim AS builder

# Instalar depend√™ncias do sistema necess√°rias para o build
RUN apt-get update && apt-get install -y --no-install-recommends \
    python3 \
    make \
    g++ \
    openssl \
    ca-certificates \
    && rm -rf /var/lib/apt/lists/*

# Definir diret√≥rio de trabalho
WORKDIR /app

# Instalar pnpm globalmente
RUN npm install -g pnpm

# Copiar apenas arquivos de configura√ß√£o para cache eficiente
COPY package.json pnpm-lock.yaml ./

# Instalar depend√™ncias com pnpm (reprodut√≠vel e r√°pido)
RUN pnpm install --frozen-lockfile

# Copiar o resto do c√≥digo fonte
COPY . .

# Validar schema do Prisma
RUN if [ ! -f "prisma/schema.prisma" ]; then \
        echo "‚ùå Schema Prisma n√£o encontrado"; \
        exit 1; \
    fi && \
    npx prisma validate

# Gerar Prisma Client (sem depender de DATABASE_URL espec√≠fica)
RUN echo "üîß Gerando Prisma Client..." && \
    npx prisma --version && \
    npx prisma generate && \
    echo "‚úÖ Prisma Client gerado com sucesso"

# Build da aplica√ß√£o NestJS
RUN echo "üèóÔ∏è Buildando aplica√ß√£o NestJS..." && \
    pnpm run build && \
    echo "‚úÖ Build conclu√≠do com sucesso"

# Remover depend√™ncias de desenvolvimento para otimizar runtime
RUN pnpm prune --prod

# Stage 2: Runtime - Imagem final otimizada para Cloud Run
FROM node:24-slim

# Instalar apenas depend√™ncias essenciais para runtime
RUN apt-get update && apt-get install -y --no-install-recommends \
    openssl \
    ca-certificates \
    && rm -rf /var/lib/apt/lists/*

# Criar usu√°rio n√£o-root para seguran√ßa
RUN addgroup --system --gid 1001 nodejs && \
    adduser --system --uid 1001 nestjs

# Definir diret√≥rio de trabalho
WORKDIR /app

# Copiar apenas o necess√°rio do est√°gio builder
COPY --from=builder --chown=nestjs:nodejs /app/node_modules ./node_modules
COPY --from=builder --chown=nestjs:nodejs /app/package.json ./
COPY --from=builder --chown=nestjs:nodejs /app/dist ./dist
COPY --from=builder --chown=nestjs:nodejs /app/prisma ./prisma

# Definir vari√°veis de ambiente para Cloud Run
ENV NODE_ENV=production \
    PORT=8080

# Expor porta padr√£o do Cloud Run
EXPOSE 8080

# Mudar para usu√°rio n√£o-root
USER nestjs

# Comando de inicializa√ß√£o
CMD ["node", "dist/src/main.js"]
